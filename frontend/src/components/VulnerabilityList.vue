<template>
  <el-card class="vulnerability-card">
    <template #header>
      <div class="card-header">
        <span>漏洞列表</span>
        <el-button type="primary" @click="collectVulnerabilities" :loading="collecting">收集漏洞</el-button>
      </div>
    </template>
    <el-table v-loading="loading" :data="sortedVulnerabilities" style="width: 100%" class="vulnerability-table">
      <el-table-column label="序号" min-width="80">
        <template #default="scope">
          {{ scope.$index + 1 }}
        </template>
      </el-table-column>
      <el-table-column label="漏洞名称" min-width="200">
        <template #default="scope">
          <a :href="getNvdLink(scope.row.name)" target="_blank" :title="scope.row.name" class="vuln-link">
            {{ scope.row.name }}
          </a>
        </template>
      </el-table-column>
      <el-table-column label="严重性" min-width="120">
        <template #default="scope">
          <el-tag :type="getSeverityType(scope.row.severity || '低危')" class="severity-tag">
            {{ scope.row.severity || '未知' }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="description" label="描述" min-width="400">
        <template #default="scope">
          <span class="description-text">{{ scope.row.description }}</span>
        </template>
      </el-table-column>
      <el-table-column prop="publish_date" label="发布日期" min-width="150">
        <template #default="scope">
          <span class="centered-date">{{ scope.row.publish_date }}</span>
        </template>
      </el-table-column>
    </el-table>
  </el-card>
</template>

<script>
export default {
  data() {
    return {
      vulnerabilities: [],
      loading: false,
      collecting: false,
    };
  },
  computed: {
    // 按发布日期倒序排序
    sortedVulnerabilities() {
      return [...this.vulnerabilities].sort((a, b) => {
        const dateA = new Date(a.publish_date);
        const dateB = new Date(b.publish_date);
        return dateB - dateA; // 倒序排列
      });
    }
  },
  methods: {
    // 根据危害等级返回 Element UI 的标签类型
    getSeverityType(severity) {
      const severityMap = {
        '高危': 'danger',
        '中危': 'warning',
        '低危': 'info',
        '无影响': 'info',
        '无': 'info',
        '未知': 'info',
        '严重': 'danger'
      };
      return severityMap[severity] || 'info';
    },
    // 生成 NVD 参考链接
    getNvdLink(cveId) {
      if (cveId && cveId.startsWith('CVE-')) {
        return `https://nvd.nist.gov/vuln/detail/${cveId}`;
      }
      return '#'; // 如果没有有效的 CVE ID，返回一个占位符
    },
    // 获取漏洞列表
    async fetchVulnerabilities() {
      this.loading = true;
      try {
        const response = await this.$axios.get('/api/vulnerabilities');
        this.vulnerabilities = response.data;
      } catch (error) {
        console.error('获取漏洞失败:', error);
        this.$message.error('获取漏洞失败，请稍后重试');
      } finally {
        this.loading = false;
      }
    },
    // 触发后端收集最新漏洞
    async collectVulnerabilities() {
      this.collecting = true;
      try {
        const response = await this.$axios.post('/api/collect_vulnerabilities');
        this.$message.success(`成功收集到 ${response.data.count} 条新漏洞。`);
        await this.fetchVulnerabilities(); // 收集完成后刷新列表
      } catch (error) {
        console.error('收集漏洞失败:', error);
        const errorMessage = error.response && error.response.data && error.response.data.message
                           ? error.response.data.message
                           : '收集漏洞失败，请稍后重试。';
        this.$message.error(errorMessage);
      } finally {
        this.collecting = false;
      }
    }
  },
  mounted() {
    // 组件挂载时自动加载漏洞列表
    this.fetchVulnerabilities();
  }
};
</script>

<style scoped>
.vulnerability-card {
  margin: 20px 0;
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  width: 100%; /* 确保卡片占满容器宽度 */
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
  background-color: #f5f7fa;
  border-bottom: 1px solid #ebeef5;
}

.vulnerability-table {
  margin: 0;
  width: 100% !important; /* 强制表格占满卡片宽度 */
  border-collapse: collapse; /* 去除默认边距 */
}

.vuln-link {
  color: #409EFF;
  text-decoration: none;
  transition: color 0.3s;
}

.vuln-link:hover {
  color: #66b1ff;
  text-decoration: underline;
}

.severity-tag {
  margin: 0;
  padding: 4px 8px;
  font-size: 12px;
}

.description-text {
  word-break: break-word;
  white-space: pre-wrap;
  line-height: 1.5;
}

.centered-date {
  display: block;
  text-align: center;
}

.el-table th {
  background-color: #f5f7fa;
  font-weight: 500;
  padding: 8px;
}

.el-table td {
  padding: 8px;
}

.el-table tr:hover {
  background-color: #f5f7fa !important;
}

.el-table::before {
  height: 0; /* 移除表格下方的默认边框 */
}

/* 确保表格内容占满容器 */
.el-table__body-wrapper {
  width: 100% !important;
  overflow-x: auto; /* 如果内容过长，添加横向滚动 */
}
</style>
