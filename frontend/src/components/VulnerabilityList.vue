<template>
  <el-card>
    <template #header>
      <div class="card-header">
        <span>漏洞列表</span>
        <el-button type="primary" @click="collectVulnerabilities" :loading="collecting">收集漏洞</el-button>
      </div>
    </template>
    <el-table v-loading="loading" :data="vulnerabilities" style="width: 100%">
      <el-table-column label="漏洞名称">
        <template #default="scope">
          <a v-if="isValidUrl(scope.row.solution)" :href="scope.row.solution" target="_blank" :title="scope.row.solution">
            {{ scope.row.name }}
          </a>
          <span v-else>{{ scope.row.name }}</span>
        </template>
      </el-table-column>
      <el-table-column label="严重性">
        <template #default="scope">
          <el-tag :type="getSeverityType(scope.row.severity || '低危')">{{ scope.row.severity || '未知' }}</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="description" label="描述"></el-table-column>
      <el-table-column prop="affected_systems" label="受影响系统"></el-table-column>
      <el-table-column prop="solution" label="解决方案"></el-table-column>
      <el-table-column prop="publish_date" label="发布日期"></el-table-column>
      <el-table-column prop="source" label="来源"></el-table-column>
    </el-table>
  </el-card>
</template>

<script>
export default {
  data() {
    return {
      vulnerabilities: [],
      loading: false,
      collecting: false,
    };
  },
  methods: {
    // 根据危害等级返回 Element UI 的标签类型
    getSeverityType(severity) {
      const severityMap = {
        '高危': 'danger',
        '中危': 'warning',
        '低危': 'info',
        '无影响': 'info', // 匹配后端可能的“无影响”
        '无': 'info',     // 匹配后端可能的“无”
        '未知': 'info',   // 默认未知
        '严重': 'danger'  // 匹配后端可能的“严重”
      };
      return severityMap[severity] || 'info';
    },
    // 判断字符串是否为有效的URL
    isValidUrl(string) {
      try {
        new URL(string);
        // 额外的判断：排除掉后端默认的非URL解决方案文本
        // 请确保这个字符串和后端 `solution = "请参考官方建议或联系供应商获取修补方案"` 保持一致
        if (string === "请参考官方建议或联系供应商获取修补方案") {
            return false;
        }
        return true;
      } catch (e) {
        return false;
      }
    },
    // 获取漏洞列表
    async fetchVulnerabilities() {
      this.loading = true;
      try {
        // 确保您的Vue项目已经配置了axios baseUrl，或者在这里使用完整的后端URL
        const response = await this.$axios.get('/api/vulnerabilities');
        this.vulnerabilities = response.data;
      } catch (error) {
        console.error('获取漏洞失败:', error);
        this.$message.error('获取漏洞失败，请稍后重试');
      } finally {
        this.loading = false;
      }
    },
    // 触发后端收集最新漏洞
    async collectVulnerabilities() {
      this.collecting = true;
      try {
        const response = await this.$axios.post('/api/collect_vulnerabilities');
        // 根据后端返回的 { "status": "success", "count": N } 结构
        this.$message.success(`成功收集到 ${response.data.count} 条新漏洞。`);
        await this.fetchVulnerabilities(); // 收集完成后刷新列表
      } catch (error) {
        console.error('收集漏洞失败:', error);
        // 尝试从错误响应中获取具体错误信息
        const errorMessage = error.response && error.response.data && error.response.data.message
                           ? error.response.data.message
                           : '收集漏洞失败，请稍后重试。';
        this.$message.error(errorMessage);
      } finally {
        this.collecting = false;
      }
    }
  },
  mounted() {
    // 组件挂载时自动加载漏洞列表
    this.fetchVulnerabilities();
  }
};
</script>

<style scoped>
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
/* 为漏洞名称的链接添加样式，使其更明显 */
.el-table-column a {
  color: #409EFF; /* Element UI 默认的主题蓝色 */
  text-decoration: none; /* 默认无下划线 */
  cursor: pointer;
}
.el-table-column a:hover {
  text-decoration: underline; /* 鼠标悬停时显示下划线 */
}
</style>
